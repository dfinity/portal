name: Validate Submodule Commits
on:
  pull_request:
    branches:
      - master

jobs:
  submodule-commit-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Validate submodule commits
        run: |
          # Submodules are very easy to accidentally overwrite with old versions.
          # To make submodule updates more explicit and to prevent accidental changes we check the revisions explicitly here.
          
          # dfx 0.27.0
          LATEST_SDK="57bcf3ebb40a66a68743955c0c9560bf1c03abe7"

          # motoko new docs 7/21/2025
          LATEST_MOTOKO="17356d83bda10af4ab4faef79c3a3f34eb870df7"

          # Get current submodule commits
          SDK_HASH=$(git submodule status submodules/sdk | awk '{print $1}')
          MOTOKO_HASH=$(git submodule status submodules/motoko | awk '{print $1}')

          # Validate SDK commit
          if [[ "$SDK_HASH" != "$LATEST_SDK"* ]]; then
            echo "Error: SDK submodule is not on the latest release commit"
            exit 1
          fi

          # Validate Motoko commit
          if [[ "$MOTOKO_HASH" != "$LATEST_MOTOKO"* ]]; then
            echo "Error: Motoko submodule is not on the latest release commit"
            exit 1
          fi

          echo "All submodules are on their latest release commits"
