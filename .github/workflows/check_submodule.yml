name: Validate Submodule Commits
on:
  pull_request:
    branches:
      - master

jobs:
  submodule-commit-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Validate submodule commits
        run: |
          # Submodules are very easy to accidentally overwrite with old versions.
          # To make submodule updates more explicit and to prevent accidental changes we check the revisions explicitly here.
          
          # dfx 0.29.0
          LATEST_SDK="d3a8c3908995ae2e434e17a45d1c8de6a32988c4"

          # motoko new docs 7/21/2025
          LATEST_MOTOKO="3ec4d7300e3ad9af8abffe6d5c436707781c5906"

          # Get current submodule commits
          SDK_HASH=$(git submodule status submodules/sdk | awk '{print $1}')
          MOTOKO_HASH=$(git submodule status submodules/motoko | awk '{print $1}')

          # Validate SDK commit
          if [[ "$SDK_HASH" != "$LATEST_SDK"* ]]; then
            echo "Error: SDK submodule is not on the latest release commit"
            exit 1
          fi

          # Validate Motoko commit
          if [[ "$MOTOKO_HASH" != "$LATEST_MOTOKO"* ]]; then
            echo "Error: Motoko submodule is not on the latest release commit"
            exit 1
          fi

          echo "All submodules are on their latest release commits"
